<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>æœ‰ä¼‘ãƒ»æ¬ å‹¤ãƒ»é…åˆ»ãƒ»æ—©é€€ãƒ»å¤–å‡º ç”³è«‹ãƒ•ã‚©ãƒ¼ãƒ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- Flatpickr æœ¬ä½“ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

  <!-- æ—¥æœ¬èªåŒ–ï¼ˆå¿…è¦ãªã‚‰ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 1em;
      background: #f8f8f8;
      max-width: 600px;
      margin: auto;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 0.5em;
      font-size: 1em;
      margin-top: 0.3em;
      box-sizing: border-box;
    }

    button {
      margin-top: 2em;
      width: 100%;
      padding: 0.8em;
      background-color: #06c755;
      color: white;
      font-size: 1.2em;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .approver-section {
      margin-top: 1em;
      padding: 1em;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 0 4px rgba(0, 0, 0, .1);
    }

    .user-summary {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #fff;

      /* ãƒ‡ã‚¶ã‚¤ãƒ³æ¼”å‡ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ */
      backdrop-filter: blur(3px);
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #06c755;
      border-radius: 10px;
      padding: .8em 1em;
      color: #333;
    }

    .user-summary .label {
      display: inline-block;
      width: 4em;
      font-weight: 700;
      color: #555;
      vertical-align: middle;
    }

    #user-name {
      font-size: 1.2em;
      font-weight: 700;
      vertical-align: middle;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 9999;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      justify-content: center;
      align-items: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #fff;
      width: min(90vw, 360px);
      border-radius: 12px;
      padding: 1.2em 1.2em 1em;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .2);
    }

    .modal-title {
      margin: 0 0 .6em;
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
    }

    .modal-text {
      white-space: pre-line;
      line-height: 1.6;
      color: #333;
    }

    .modal-buttons {
      display: flex;
      gap: .6em;
      margin-top: 1em;
    }

    .modal-buttons button {
      flex: 1;
      padding: .6em 1em;
      border: 0;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-yes {
      background: #06c755;
      color: #fff;
    }

    .btn-no {
      background: #e9ecef;
      color: #333;
    }

    #debug {
      white-space: pre-line;
      color: crimson;
      font-size: .9em;
      margin-top: 2em;
    }

    #daysContainer {
      margin: 1rem 0;
      padding: .9rem 1.1rem;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .6rem;
      border: 2px solid #06c75522;
    }

    #daysLabel {
      font-weight: 700;
      color: #333;
      letter-spacing: .02em;
    }

    #days {
      display: inline-block;
      min-width: 3.2em;
      text-align: center;
      font-weight: 900;
      font-size: 1.8rem;
      line-height: 1.2;
      padding: .2rem .6rem;
      border-radius: 8px;
      /* è¦ªè¦ç´ ã¯è‰²æŒ‡å®šã—ãªã„ã»ã†ãŒã„ã„ */
      color: inherit;
    }

    #daysUnit {
      color: #555;
      font-weight: 700;
    }

    #daysValue {
      display: inline-block !important;
      visibility: visible !important;
      color: #000 !important;
      font-size: 1.2em;
      font-weight: bold;
    }

    #daysValue.pulse {
      display: inline-block;
      animation: pop 400ms ease;
    }

    @keyframes pop {
      0% {
        transform: scale(1);
      }

      40% {
        transform: scale(1.3);
      }

      100% {
        transform: scale(1);
      }
    }

    #hoursContainer {
      margin: 1rem 0;
      padding: .9rem 1.1rem;
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .6rem;
      border: 2px solid #06c75522;
    }

    #hoursLabel {
      font-weight: 700;
      color: #333;
      letter-spacing: .02em;
    }

    #hours {
      display: inline-block;
      min-width: 3.2em;
      text-align: center;
      font-weight: 900;
      font-size: 1.8rem;
      line-height: 1.2;
      padding: .2rem .6rem;
      border-radius: 8px;
      color: inherit;
    }

    #hoursUnit {
      color: #555;
      font-weight: 700;
    }

    #hoursValue {
      display: inline-block;
    }

    #hoursValue.pulse {
      animation: pop 400ms ease;
    }

    /* ã‚»ãƒ¬ã‚¯ãƒˆã‚’1è¡Œã«åã‚ã¦çœç•¥è¡¨ç¤ºï¼ˆå¿…è¦ãªã‚‰ï¼‰ */
    .approver-section select {
      width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="modal-content">
      <h2 id="confirmTitle" class="modal-title">ç¢ºèª</h2>
      <p id="confirmText" class="modal-text"></p>
      <div class="modal-buttons">
        <button type="button" class="btn-no" id="modalNo">ã„ã„ãˆ</button>
        <button type="button" class="btn-yes" id="modalYes">ã¯ã„</button>
      </div>
    </div>
  </div>

  <h1>ğŸ“„ æœ‰ä¼‘ãƒ»æ¬ å‹¤ãƒ»é…åˆ»<br />æ—©é€€ãƒ»å¤–å‡º ç”³è«‹</h1>

  <div id="link-section" style="display:none">
    <label for="department_select">æ‰€å±éƒ¨ç½²ã‚’é¸ã‚“ã§ãã ã•ã„</label>
    <select id="department_select">
      <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
    </select>

    <label for="user_select">ã‚ãªãŸã®ãŠåå‰ã‚’é¸ã‚“ã§ãã ã•ã„</label>
    <select id="user_select" disabled>
      <option value="">-- æ°åã‚’é¸æŠ --</option>
    </select>

    <button id="doLink" disabled>ç™»éŒ²ã™ã‚‹</button>
    <p style="font-size:.9em;color:#666;margin-top:.5em;">â€» åˆå›ã®ã¿å¿…è¦ã§ã™ã€‚ä»¥é™ã¯è‡ªå‹•çš„ã«æœ¬äººã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>
  </div>

  <div id="form-section" style="display:none">
    <div class="user-summary" id="userSummary" aria-live="polite">
      <div><span class="label">æ‰€å±</span><span id="user-dept">-</span></div>
      <div><span class="label">æ°å</span><span id="user-name">-</span></div>
    </div>

    <label for="leave_type">ç”³è«‹ç¨®åˆ¥</label>
    <select id="leave_type" required>
      <option value="full_day">å…¨æ—¥ä¼‘</option>
      <option value="first_half">å‰åŠä¼‘</option>
      <option value="second_half">å¾ŒåŠä¼‘</option>
      <option value="special_leave">ç‰¹åˆ¥ä¼‘</option>
      <option value="absence">æ¬ å‹¤</option>
      <option value="late">é…åˆ»</option>
      <option value="leave_early">æ—©é€€</option>
      <option value="outing">å¤–å‡º</option>
    </select>

    <label for="start_date">é–‹å§‹æ—¥</label>
    <input type="date" id="start_date" required />

    <label for="end_date">çµ‚äº†æ—¥ <small style="color:#666;">ï¼ˆç©ºãªã‚‰é–‹å§‹æ—¥ã¨åŒã˜ï¼‰</small></label>
    <input type="date" id="end_date" />
    <div id="daysContainer">
      <span id="daysLabel">å–å¾—æ—¥æ•°</span>ï¼š
      <span id="days"><span id="daysValue">-</span></span>
      <span id="daysUnit">æ—¥</span>
    </div>
    <style>
      #time_section {
        visibility: hidden;
        height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s ease;
      }

      #time_section.visible {
        visibility: visible;
        height: auto;
        opacity: 1;
      }
    </style>

    <div class="time-group" id="time_section">
      <label for="start_time">é–‹å§‹æ™‚åˆ»</label>
      <input type="text" id="start_time">

      <label for="end_time">çµ‚äº†æ™‚åˆ»</label>
      <input type="text" id="end_time">
    </div>
    <div id="hoursContainer" style="display: none;">
      <span id="hoursLabel">å–å¾—æ™‚é–“</span>ï¼š
      <span id="hours"><span id="hoursValue">-</span></span>
    </div>
    <label for="reason">ç”³è«‹ç†ç”±ï¼ˆä»»æ„ï¼‰</label>
    <textarea id="reason" rows="4" placeholder="ä¾‹ï¼šé€šé™¢ã®ãŸã‚ 10:00ã€œ11:30"></textarea>

    <div class="approver-section">
      <label for="approver_user_id">ç”³è«‹å…ˆï¼ˆæ‰¿èªè€…ï¼‰</label>
      <select id="approver_user_id" required>
        <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
      </select>
    </div>

    <button id="btnSubmit" type="button">ğŸ“¨ ç”³è«‹ã™ã‚‹</button>
    <button id="btnReset" type="button" style="margin-top:1em;background:#e0e0e0;color:#333;">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="btnDeleteLink" type="button" style="margin-top:1em;background:#ef4444;color:#fff;">ç”³è«‹è€…åã®å†ç™»éŒ²</button>
  </div>

  <div id="debug"></div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const debugLog = (msg) => {
      let el = document.getElementById('debug');
      if (!el) {
        el = document.createElement('pre');
        el.id = 'debug';
        el.style = "font-size: 0.9em; color: gray; background: #f0f0f0; max-height: 200px; overflow-y: auto;";
        document.body.appendChild(el);
      }
      el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
    };
    const show = (id, v = true) => { const el = document.getElementById(id); if (el) el.style.display = v ? 'block' : 'none'; };

    function showLink() { show('form-section', false); show('link-section', true); window.__mode = 'link'; }
    function showForm() { show('link-section', false); show('form-section', true); window.__mode = 'form'; }

    async function fetchSafe(url, options = {}, timeoutMs = 10000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try {
        const res = await fetch(url, { ...options, signal: ctrl.signal });
        return res;
      } finally {
        clearTimeout(t);
      }
    }

    function debugDaysParams(stage) {
      const s = document.getElementById('start_date');
      const e = document.getElementById('end_date');
      const lt = document.getElementById('leave_type');
      const dbg = document.getElementById('debug');
      if (!dbg) return;

      dbg.textContent += `[${stage}] start=${s.value}, end=${e.value}, leave_type=${lt?.value}\n`;
    }

    function setupFormInteractions() {
      const leaveType = document.getElementById('leave_type');
      const s = document.getElementById('start_date');
      const e = document.getElementById('end_date');

      // ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæ•°å­—ãã®ã‚‚ã®(#daysValue)ã‚’ç›´æ¥ã„ã˜ã‚‹
      const daysValue = document.getElementById('daysValue');
      const daysWrap = document.getElementById('days');          // è¦ªã®æ 
      const wrap = document.getElementById('daysContainer'); // ãƒœãƒƒã‚¯ã‚¹å…¨ä½“

      const showDays = () =>
        (leaveType.value === 'full_day' || leaveType.value === 'absence' || leaveType.value === 'special_leave');
      const updateVis = () => {
        const vis = showDays();
        wrap.style.display = vis ? 'block' : 'none';
        if (!vis) {
          e.value = '';
          daysValue.textContent = '-';
        }
      };

      // é–‹å§‹æ—¥ã«å…¥ã‚ŒãŸã‚‰ã€çµ‚äº†æ—¥ãŒç©ºãªã‚‰åŒã˜æ—¥ã«è‡ªå‹•ã‚³ãƒ”ãƒ¼
      s.addEventListener('change', () => {
        if (!e.value) e.value = s.value;
        if (e.value && s.value && s.value > e.value) e.value = s.value;
        fetchDays();
      });
      e.addEventListener('change', () => {
        if (e.value && s.value && s.value > e.value) e.value = s.value;
        fetchDays();
      });
      leaveType.addEventListener('change', () => { updateVis(); updateTimeInputs(); fetchDays(); });

      // replaceAll ã‚’ä½¿ã‚ãªã„ã§ YYYYMMDD åŒ–
      const toYYYYMMDD = (v) => (v || '').split('-').join('');

      async function fetchDays() {
        if (!showDays()) {
          return;
        }

        const sv = s.value;
        const ev = e.value || s.value;

        if (!sv) {
          daysValue.textContent = '-';
          return;
        }

        const startStr = toYYYYMMDD(sv);
        const endStr = toYYYYMMDD(ev);

        try {
          const r = await fetch(`/api/workdays?start=${startStr}&end=${endStr}`);
          const raw = await r.text();
          const d = raw ? JSON.parse(raw) : {};
          const value = (d && typeof d.days !== 'undefined') ? d.days : '-';
          daysValue.textContent = value;

          // ã‚¢ãƒ‹ãƒ¡å†é©ç”¨
          daysValue.classList.remove('pulse');
          void daysValue.offsetWidth;
          setTimeout(() => {
            daysValue.classList.add('pulse');
          }, 50);
        } catch (err) {
          daysValue.textContent = '-';
          const dbg = document.getElementById('debug');
          if (dbg) dbg.textContent += `days err: ${err.message}\n`;
        }
      }

      const resetBtn = document.getElementById('btnReset');
      resetBtn.addEventListener('click', () => {
        // ğŸ’¥ 1. å„å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
        leaveType.value = 'full_day';
        s.value = '';
        e.value = '';
        document.getElementById('reason').value = '';
        document.getElementById('approver_user_id').selectedIndex = 0;

        // ğŸ’¥ 2. `#daysValue` ã‚’ç›´æ¥æ“ä½œï¼ˆDOMå·®ã—æ›¿ãˆã—ãªã„ï¼‰
        const dv = document.getElementById('daysValue');
        if (dv) {
          dv.textContent = '-';
          dv.classList.remove('pulse');
          void dv.offsetWidth; // å¼·åˆ¶å†æç”»ã§ã‚¢ãƒ‹ãƒ¡é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          dv.classList.add('pulse');
        }

        // ğŸ’¥ 3. è¡¨ç¤ºçŠ¶æ…‹ã‚„å–å¾—æ—¥æ•°ã®å†è©•ä¾¡
        updateVis();
        fetchDays();
      });

      // åˆæœŸåæ˜ 
      updateVis();
      fetchDays();
    }

    function updateTimeInputs() {
      const leaveType = document.getElementById('leave_type').value;
      const needTime = ['leave_early', 'outing', 'late'].includes(leaveType);
      const hideEndDate = ['first_half', 'second_half', 'late', 'leave_early', 'outing'].includes(leaveType);

      // æ™‚é–“ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºåˆ‡æ›¿
      const timeSection = document.getElementById('time_section');
      if (needTime) {
        timeSection.classList.add('visible');
      } else {
        timeSection.classList.remove('visible');
      }

      // çµ‚äº†æ—¥ãƒ©ãƒ™ãƒ«ã¨å…¥åŠ›ã®è¡¨ç¤ºåˆ‡æ›¿
      const endDateInput = document.getElementById('end_date');
      const endDateLabel = document.querySelector('label[for="end_date"]');

      if (hideEndDate) {
        endDateInput.style.display = 'none';
        endDateLabel.style.display = 'none';
      } else {
        endDateInput.style.display = '';
        endDateLabel.style.display = '';
      }
      // ğŸ’¡ å–å¾—æ™‚é–“è¡¨ç¤ºã®è¡¨ç¤ºãƒ»éè¡¨ç¤ºåˆ‡æ›¿
      const hoursContainer = document.getElementById('hoursContainer');
      if (needTime) {
        hoursContainer.style.display = 'block';
        updateHoursValue(); // â† ã¤ã„ã§ã«å†è¨ˆç®—
      } else {
        hoursContainer.style.display = 'none';
        document.getElementById('hoursValue').textContent = '-';
      }
    }

    // æ‰¿èªè€…1ä»¶ã‚’å–å¾—ã—ã¦ <select id="approver_user_id"> ã«åæ˜ 
    async function loadApprover(lineId) {
      const sel = document.getElementById('approver_user_id');
      sel.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      sel.disabled = true;

      try {
        // APIã¯ line_id å‰æ
        const r = await fetch(`/api/approvers?line_id=${encodeURIComponent(lineId)}`);
        const raw = await r.text();
        const data = raw ? JSON.parse(raw) : null;

        sel.innerHTML = '';

        // è¿”å´ä¾‹: { found:true, æ°å, position_name, department_name, user_id }
        if (!data || data.found !== true || !data.user_id) {
          sel.innerHTML = '<option value="">æ‰¿èªè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</option>';
          sel.disabled = true;
          return;
        }

        // optionã‚’1ä»¶ã ã‘ä½œæˆ
        const opt = document.createElement('option');
        opt.value = String(data.user_id);
        const label = data.position_name
          ? `${data.æ°å}ï¼ˆ${data.position_name}ï¼‰`
          : data.æ°å;
        opt.textContent = label;
        sel.appendChild(opt);

        // 1äººå›ºå®šãªã®ã§ãƒ­ãƒƒã‚¯ï¼ˆUIã¯è¡¨ç¤ºã ã‘ï¼‰
        sel.disabled = true;

        // ç”³è«‹ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°æœ‰åŠ¹åŒ–
        const btn = document.getElementById('btnSubmit');
        if (btn) btn.disabled = !opt.value;

      } catch (e) {
        sel.innerHTML = '<option value="">æ‰¿èªè€…å–å¾—ã‚¨ãƒ©ãƒ¼</option>';
        sel.disabled = true;
        const dbg = document.getElementById('debug');
        if (dbg) dbg.textContent += `approver err: ${e.message}\n`;
      }
    }

    // è¤‡æ•°æ‰¿èªè€…å–å¾—ï¼ˆuser_idã§ãƒªã‚¹ãƒˆã‚’ã‚‚ã‚‰ã†ï¼‰
    async function loadApproverByUserId(userId) {
      const sel = document.getElementById('approver_user_id');

      // è¦ç´ ãŒã¾ã ç„¡ã„ï¼ˆï¼setupFormUIå‰ï¼‰ãªã‚‰å®‰å…¨ã«æŠœã‘ã‚‹
      if (!sel) {
        return;
      }
      sel.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ä¸­...</option>';
      sel.disabled = true;

      try {
        const url = `/api/approvers?user_id=${encodeURIComponent(userId)}&list=1`;
        const r = await fetch(url);
        const raw = await r.text();
        if (!r.ok) {
          sel.innerHTML = `<option value="">HTTP ${r.status} æ‰¿èªè€…å–å¾—å¤±æ•—</option>`;
          return;
        }

        let data;
        try {
          data = raw ? JSON.parse(raw) : null;
        } catch (e) {
          sel.innerHTML = `<option value="">JSON parse error: ${e.message}</option>`;
          return;
        }

        // å˜ä½“/é…åˆ—ã©ã¡ã‚‰ã§ã‚‚é…åˆ—ã«æ­£è¦åŒ–ï¼ˆå¾Œæ–¹äº’æ›ï¼‰
        const list = Array.isArray(data)
          ? data
          : (data?.candidates || (data?.found ? [data] : []));

        sel.innerHTML = '';

        for (const a of list) {
          const uid = a.user_id ?? a.æ‰¿èªè€…ID;
          const name = a.æ°å ?? a.æ‰¿èªè€…å ?? '';
          const pos = a.position_name ?? '';
          const dept = a.department_name ?? a.department_full_name ?? '';

          const opt = document.createElement('option');
          opt.value = String(uid);

          // è¡¨ç¤ºã¯ã€Œæ°åï¼ˆå½¹è·ï¼‰ã€ã€å½¹è·ãŒç„¡ã‘ã‚Œã°æ°åã®ã¿
          opt.textContent = pos ? `${name}ï¼ˆ${pos}ï¼‰` : name;

          // title ã«éƒ¨ç½²æƒ…å ±ã‚’æ®‹ã—ã¦ã€ãƒ›ãƒãƒ¼/é•·æŠ¼ã—ã§ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
          opt.title = [name && `æ°å: ${name}`, pos && `å½¹è·: ${pos}`, dept && `éƒ¨ç½²: ${dept}`]
            .filter(Boolean).join(' / ');

          sel.appendChild(opt);
        }

        sel.selectedIndex = 0;
        sel.disabled = false;
        const btn = document.getElementById('btnSubmit');
        if (btn) btn.disabled = false;
        // âœ… ã“ã“ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿æŒã™ã‚‹
        window.__approverUserId = sel.value;

        // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚æ›´æ–°ã—ã¦ãŠã
        sel.addEventListener('change', () => {
          window.__approverUserId = sel.value;
        });
      } catch (e) {
        sel.innerHTML = '<option value="">æ‰¿èªè€…å–å¾—ã‚¨ãƒ©ãƒ¼</option>';
        debugLog(`[error] loadApproverByUserId: ${e.message}`);
      }
    }

    async function loadDepartments() {
      const sel = $('#department_select'); sel.innerHTML = '<option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>'; sel.disabled = true;
      try {
        const r = await fetch('/api/departments'); const list = await r.json();
        for (const d of (Array.isArray(list) ? list : [])) {
          const val = d.department_full_name || d.full_name || d.name || ''; const label = d.department_name || d.name || val;
          if (!val) continue; const o = document.createElement('option'); o.value = String(val); o.textContent = label; sel.appendChild(o);
        }
        sel.disabled = sel.options.length <= 1;
      } catch (e) { }
    }
    async function loadUsersByDepartment(deptFullName) {
      const sel = $('#user_select'), btn = $('#doLink');
      sel.innerHTML = '<option value="">-- æ°åã‚’é¸æŠ --</option>'; sel.disabled = true; if (btn) btn.disabled = true;
      try {
        const r = await fetch(`/api/users-by-department?department=${encodeURIComponent(deptFullName)}`);
        const list = await r.json();
        for (const u of (Array.isArray(list) ? list : [])) {
          const id = u.user_id || u.userId || u.id; const name = u.æ°å || u.name || u.full_name || u.fullName;
          if (!id || !name) continue; const o = document.createElement('option'); o.value = String(id); o.textContent = String(name); sel.appendChild(o);
        }
        sel.disabled = sel.options.length <= 1;
        sel.onchange = () => { if (btn) btn.disabled = !sel.value; };
        if (btn) btn.disabled = !sel.value;
      } catch (e) { }
    }

    async function linkLineId(lineId) {
      // --- äºŒé‡é€ä¿¡ã‚¬ãƒ¼ãƒ‰ ---
      if (window.__inFlight) {
        alert('å‡¦ç†ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚');
        return false;
      }
      window.__inFlight = true;

      // æŠ¼ä¸‹ä¸­ã¯ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼ˆäºˆé˜²ç·šï¼‰
      const doLinkBtn = document.getElementById('doLink');
      const yesBtn = document.getElementById('modalYes');
      if (doLinkBtn) doLinkBtn.disabled = true;
      if (yesBtn) yesBtn.disabled = true;

      try {
        const userId = (document.getElementById('user_select')?.value || '').trim();
        if (!userId) { alert('æ°åã‚’é¸ã‚“ã§ãã ã•ã„ã€‚'); return false; }

        const normForce = !!document.getElementById('force_check')?.checked;

        // fetchSafeã‚’å…¥ã‚Œã¦ã„ãªã„ãªã‚‰fetchã®ã¾ã¾ã§OKï¼ˆå…¥ã‚Œã¦ã„ã‚Œã° fetchSafe ã«å¤‰ãˆã¦è‰¯ã—ï¼‰
        const resp = await fetch('/api/link-lineid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lineId, userId, force: normForce })
        });

        const raw = await resp.text();
        let data = null; try { data = raw ? JSON.parse(raw) : null; } catch { }

        const ok = resp.ok && (
          !data || data.ok === true || data.success === true || String(data?.status || '').toLowerCase() === 'ok'
        );

        if (!ok) {
          const reason = (data?.error || data?.message || raw || `${resp.status} ${resp.statusText}`);
          alert(`ç´ä»˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nç†ç”±: ${reason}`);
          return false;
        }

        // æˆåŠŸï¼šç”³è«‹ç”»é¢ã¸ï¼ˆwhoamiã§åˆ¤å®šã•ã›ã‚‹ãŸã‚ã®ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
        alert('ç™»éŒ²ã—ã¾ã—ãŸã€‚');
        sessionStorage.setItem('line_linked', '1');
        location.reload();
        return true;

      } catch (e) {
        alert(`ç´ä»˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nç†ç”±: ${e?.message || 'network error'}`);
        return false;

      } finally {
        // å¤±æ•—æ™‚ã‚„ä¾‹å¤–æ™‚ã®ã¿æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹æƒ³å®šï¼ˆæˆåŠŸæ™‚ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã§é›¢è„±ï¼‰
        window.__inFlight = false;
        if (doLinkBtn) doLinkBtn.disabled = false;
        if (yesBtn) yesBtn.disabled = false;
      }
    }

    function setupLinkUI(lineId) {
      showLink();
      loadDepartments();
      $('#department_select').addEventListener('change', e => { const v = e.target.value || ''; if (v) loadUsersByDepartment(v); });
      const modal = $('#confirmModal'), text = $('#confirmText'), yes = $('#modalYes'), no = $('#modalNo');
      const open = (t) => { text.textContent = t; modal.classList.add('open'); yes.focus(); };
      const close = () => modal.classList.remove('open');
      no.addEventListener('click', close); modal.addEventListener('click', (ev) => { if (ev.target === modal) close(); });
      let yesHandler = null;
      $('#doLink').addEventListener('click', () => {
        const deptSel = $('#department_select');
        const userSel = $('#user_select');
        const deptName = deptSel.options[deptSel.selectedIndex]?.textContent || '';
        const userName = userSel.options[userSel.selectedIndex]?.textContent || '';

        const msg = `ã€Œ${deptName}ã€ã®ã€Œ${userName}ã€ã•ã‚“ã§ï¼¯ï¼«â“`;
        open(msg);

        if (yesHandler) yes.removeEventListener('click', yesHandler);
        yesHandler = async () => {
          close();
          await linkLineId(lineId);
        };
        yes.addEventListener('click', yesHandler, { once: true });
      });
    }

    async function setupFormUI(whoami) {
      showForm();
      $('#user-name').textContent = whoami.æ°å || whoami.name || '';
      const dept = whoami.department_full_name || whoami.æ‰€å±éƒ¨ç½² || whoami.éƒ¨ç½² || '';
      $('#user-dept').textContent = dept;
      window.__userId = whoami.user_id;
      setupFormInteractions();

      $('#btnSubmit').addEventListener('click', () => {
        const leaveType = $('#leave_type').value;
        const leaveLabel = $('#leave_type').selectedOptions[0]?.textContent ?? '';
        const startDate = $('#start_date').value;
        let endDate = $('#end_date').value || startDate;
        const approver = $('#approver_user_id');
        const approverName = approver.selectedOptions[0]?.textContent ?? '';
        const reason = $('#reason').value.trim();
        const days = $('#daysValue').textContent ?? '-';

        // çµ‚äº†æ—¥ãŒéè¡¨ç¤ºã ã£ãŸã‚‰è‡ªå‹•çš„ã«é–‹å§‹æ—¥ã‚’ä»£å…¥
        const hideEndDate = ['first_half', 'second_half', 'late', 'leave_early', 'outing'].includes(document.getElementById('leave_type').value);
        if (hideEndDate || !endDate) {
          endDate = startDate;
        }

        if (!leaveType) return alert('ç”³è«‹ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        if (!startDate) return alert('é–‹å§‹æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if (!endDate) return alert('çµ‚äº†æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        if (!approver.value) return alert('æ‰¿èªè€…ã‚’é¸æŠã—ã¦ãã ã•ã„');

        // ğŸ“„ ç¢ºèªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ„ã¿ç«‹ã¦
        const lines = [
          `ã€ç”³è«‹å†…å®¹ã€‘`,
          `ç¨®åˆ¥ï¼š${leaveLabel}`,
          `æœŸé–“ï¼š${startDate} ï½ ${endDate}${(leaveType === 'full_day' || leaveType === 'absence' || leaveType === 'special_leave') ? `ï¼ˆ${days}æ—¥é–“ï¼‰` : ''}`,
        ];

        // æ™‚é–“å…¥åŠ›ãŒå¿…è¦ãªç¨®åˆ¥ã ã‘è¡¨ç¤º
        const needTime = ['leave_early', 'absence', 'outing', 'late'].includes(leaveType);
        if (needTime) {
          const st = document.getElementById('start_time').value;
          const et = document.getElementById('end_time').value;

          if (st && et) {
            lines.push(`æ™‚é–“ï¼š${st} ï½ ${et}`);
          }
        }

        // ğŸ’¡ æ‰¿èªè€…ã¯ã“ã“ã§å‡ºã™ï¼ˆæ™‚é–“ã®å¾Œï¼‰
        lines.push(`ç”³è«‹å…ˆï¼š${approverName}`);

        // ç†ç”±ï¼ˆä»»æ„ï¼‰
        if (reason) {
          lines.push(`ç†ç”±ï¼š${reason}`);
        }

        const modal = $('#confirmModal');
        const text = $('#confirmText');
        const yes = $('#modalYes');
        const no = $('#modalNo');

        text.textContent = 'ä»¥ä¸‹ã®å†…å®¹ã§ç”³è«‹ã—ã¾ã™ã‹ï¼Ÿ\n\n' + lines.join('\n');
        modal.classList.add('open');
        yes.focus();

        no.addEventListener('click', () => {
          modal.classList.remove('open');
        });

        const handlerOnce = async () => {
          modal.classList.remove('open');
          // yes.removeEventListener('click', handlerOnce); â† once:true ã«ã™ã‚‹ã®ã§ä¸è¦
          const request_id = crypto.randomUUID();
          const payload = {
            request_id: request_id,
            user_id: window.__userId,
            department_full_name: document.getElementById('user-dept').textContent.trim(),
            leave_type: document.getElementById('leave_type').value,
            start_date: document.getElementById('start_date').value,
            end_date: document.getElementById('end_date')?.value || null,
            start_time: document.getElementById('start_time')?.value || null,
            end_time: document.getElementById('end_time')?.value || null,
            reason: document.getElementById('reason')?.value || null,
            contact_method: document.getElementById('contact_method')?.value || null,
            approver_user_id: window.__approverUserId
          };

          try {
            const res = await fetch('/api/submit-request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (res.ok) {
              // ç”³è«‹è€…æƒ…å ±ï¼ˆé€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ã«é€ã‚‹ï¼‰
              const applicantName = document.getElementById('user-name').textContent.trim();

              // æ‰¿èªè€…ã¸é€šçŸ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
              try {
                const notifyRes = await fetch('/api/notify-approver', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    request_id: payload.request_id,
                    approver_user_id: payload.approver_user_id,
                    applicant_name: applicantName,
                    leave_type: leaveLabel,
                    start_date: payload.start_date,
                    end_date: payload.end_date
                  })
                });

                const notifyData = await notifyRes.json();
                debugLog("ğŸ“© notify-approverçµæœ:", notifyData);

              } catch (notifyErr) {
                debugLog('âš ï¸ æ‰¿èªè€…é€šçŸ¥ã‚¨ãƒ©ãƒ¼:', notifyErr);
              }

              alert('ğŸ“¨ ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚\næ‰¿èªè€…ã«LINEé€šçŸ¥ã‚’é€ã£ã¦ã„ã¾ã™ã€‚');
              //liff.closeWindow();
            }

          } catch (err) {
            debugLog('âŒ ç”³è«‹é€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
            alert('ç”³è«‹ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
          }
        };

        // âœ… ã“ã“ãŒæŠœã‘ã¦ã„ãŸ
        yes.addEventListener('click', handlerOnce, { once: true });

        // TODO: é€ä¿¡å¾Œã«ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆãªã©ã‚ã‚Œã°ã“ã“ã«æ›¸ã
      });

      $('#btnDeleteLink').addEventListener('click', async () => {
        if (!confirm('ã“ã®ã‚¹ãƒãƒ›ã‹ã‚‰ã®ç”³è«‹ç™»éŒ²ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

        const btn = $('#btnDeleteLink');
        if (window.__inFlight) return;
        window.__inFlight = true;

        const origText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'è§£é™¤ä¸­...';

        try {
          const res = await fetch('/api/unlink-lineid', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lineId: window.__lineId, userId: whoami.user_id, force: false })
          });

          const raw = await res.text();
          let data = null;
          try { data = raw ? JSON.parse(raw) : null; } catch { }

          const ok = res.ok && (data?.success || data?.ok);
          if (ok) {
            alert('è§£é™¤ã—ã¾ã—ãŸ');
            location.reload();
          } else {
            const msg = data?.error || data?.message || raw || `${res.status} ${res.statusText}`;
            alert(`è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n${msg}`);
          }
        } catch (e) {
          alert(`è§£é™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n${e.message}`);
          debugLog('unlink: ' + e.message);
        } finally {
          window.__inFlight = false;
          btn.disabled = false;
          btn.textContent = origText;
        }
      });
      updateTimeInputs();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã¯æœ€åˆã«1å›ã ã‘å®£è¨€ã—ã¦ä½¿ã„å›ã™
      const modal = document.getElementById('confirmModal');
      const text = document.getElementById('confirmText');
      const yes = document.getElementById('modalYes');
      const no = document.getElementById('modalNo');
      try {
        await liff.init({ liffId: '2007688662-ElLglqWR' });
        if (!liff.isInClient()) { alert('ã“ã®ç”»é¢ã¯LINEã‚¢ãƒ—ãƒªå†…ã§ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚'); return; }
        const lineId = liff.getContext().userId;
        if (!lineId) { alert('LINEãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); return; }
        window.__lineId = lineId;

        const whoRes = await fetch(`/api/whoami?lineId=${encodeURIComponent(lineId)}`);
        const whoami = await whoRes.json();
        //await loadApproverList(whoami.user_id);
        //debugLog("whoami: " + JSON.stringify(whoami));

        if (whoami?.found) {
          await setupFormUI(whoami);
          await loadApproverByUserId(whoami.user_id);
        } else {
          await setupLinkUI(lineId);
        }

        if (sessionStorage.getItem('line_linked') === '1') {
          sessionStorage.removeItem('line_linked');
          if (!whoami?.found) location.reload();
        }
      } catch (err) {
        debugLog('âŒ LIFFåˆæœŸåŒ–å¤±æ•—:', err);
        debugLog('init: ' + err.message);
        alert('åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    });

    // ğŸ”§ æ‰¿èªè€…å€™è£œã®å–å¾—ï¼†ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
    async function loadApproverList(userId) {
      try {
        const res = await fetch(`/api/approvers?user_id=${encodeURIComponent(userId)}&list=1`);
        const approvers = await res.json();

        if (!approvers.length) {
          const opt = document.createElement('option');
          opt.textContent = 'æ‰¿èªè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          opt.disabled = true;
          opt.selected = true;
          sel.appendChild(opt);
          sel.disabled = true;
          return;
        }

        approvers.forEach(data => {
          const opt = document.createElement('option');
          opt.value = String(data.æ‰¿èªè€…ID);
          opt.textContent = data.position_name
            ? `${data.æ‰¿èªè€…å}ï¼ˆ${data.position_name}ï¼‰`
            : data.æ‰¿èªè€…å;
          sel.appendChild(opt);
        });

        sel.selectedIndex = 0;
        sel.disabled = false;
      } catch (err) {
        debugLog("æ‰¿èªè€…å–å¾—å¤±æ•—:", err);
        alert("æ‰¿èªè€…ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      const startTimeInput = document.getElementById('start_time');
      const endTimeInput = document.getElementById('end_time');

      const startPicker = flatpickr(startTimeInput, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        locale: "ja",
        onChange: function (selectedDates) {
          const start = selectedDates[0];
          const end = endTimeInput._flatpickr.selectedDates[0];
          updateEndIfStartOnly(start);
          updateHoursValue();
          fixIfInconsistent(start, end);
        },
        onClose: function (selectedDates) {
          const start = selectedDates[0];
          const end = endTimeInput._flatpickr.selectedDates[0];
          updateEndIfStartOnly(start);
          updateHoursValue();
          fixIfInconsistent(start, end);
        }
      });

      const endPicker = flatpickr(endTimeInput, {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true,
        locale: "ja",
        onChange: function (selectedDates) {
          const end = selectedDates[0];
          const start = startTimeInput._flatpickr.selectedDates[0];
          updateStartIfEndOnly(end);
          updateHoursValue();
          fixIfInconsistent(start, end);
        },
        onClose: function (selectedDates) {
          const end = selectedDates[0];
          const start = startTimeInput._flatpickr.selectedDates[0];
          updateStartIfEndOnly(end);
          updateHoursValue();
          fixIfInconsistent(start, end);
        }
      });

      updateTimeInputs(); // æœ€åˆã«å‘¼ã¶
      document.getElementById('leave_type').addEventListener('change', updateTimeInputs);
    });

    let timeErrorAlreadyShown = false;

    function fixIfInconsistent(start, end) {
      if (!start || !end) return;

      if (start >= end) {
        if (!timeErrorAlreadyShown) {
          alert('âš ï¸ æ™‚åˆ»ã®å…¥åŠ›ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚');
          timeErrorAlreadyShown = true;
        }
        return;
      }

      // ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã‹ã£ãŸãªã‚‰ã€æ¬¡ã®åˆ¤å®šã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
      timeErrorAlreadyShown = false;
    }

    function updateEndIfStartOnly(start) {
      if (!start) return;

      const endInput = document.getElementById('end_time');
      const endPicker = endInput._flatpickr;

      // ã™ã§ã«çµ‚äº†æ™‚é–“ãŒå…¥ã£ã¦ã„ãŸã‚‰è£œå®Œã—ãªã„
      if (!endPicker || endPicker.selectedDates[0]) return;

      // +1æ™‚é–“è£œå®Œ
      const newEnd = new Date(start.getTime() + 60 * 60 * 1000);
      endPicker.setDate(newEnd, true);
    }

    function updateStartIfEndOnly(end) {
      if (!end) return;

      const startInput = document.getElementById('start_time');
      const startPicker = startInput._flatpickr;

      // ã™ã§ã«é–‹å§‹æ™‚é–“ãŒå…¥ã£ã¦ã„ãŸã‚‰è£œå®Œã—ãªã„
      if (!startPicker || startPicker.selectedDates[0]) return;

      // -1æ™‚é–“è£œå®Œ
      const newStart = new Date(end.getTime() - 60 * 60 * 1000);
      startPicker.setDate(newStart, true);
    }

    function updateHoursValue() {
      const start = document.getElementById('start_time')._flatpickr?.selectedDates[0];
      const end = document.getElementById('end_time')._flatpickr?.selectedDates[0];
      const el = document.getElementById('hoursValue');

      if (!start || !end || start >= end) {
        el.textContent = '-';
        el.classList.remove('pulse');
        return;
      }

      const diffMs = end - start;
      const totalMinutes = Math.floor(diffMs / (1000 * 60));
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;

      let display = '';
      if (hours > 0) display += `${hours}æ™‚é–“`;
      if (minutes > 0) display += `${minutes}åˆ†`;
      if (hours === 0 && minutes === 0) display = '0åˆ†';

      el.textContent = display;

      // ğŸ‰ ãƒãƒ³ãƒƒã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      el.classList.remove('pulse');
      void el.offsetWidth;
      setTimeout(() => el.classList.add('pulse'), 50);
    }

    // äºŒé‡é€ä¿¡ã‚¬ãƒ¼ãƒ‰
    window.__inFlight = false;

  </script>
</body>

</html>